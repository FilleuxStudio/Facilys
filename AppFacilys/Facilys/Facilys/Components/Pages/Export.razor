@page "/export"
@rendermode InteractiveServer
@inject PageTitleService PageTitleService
@inject IJSRuntime JSRuntime
@inject UserConnectionService UserConnection
@inject IDbContextFactory<ApplicationDbContext> DbContextFactory


<div class="row justify-content-center">
    <div class="col-md-6 col-lg-3">
        <div class="card">
            <div class="card-body">
                <div class="dropdown float-end">
                    <a href="#" class="text-muted fs-16 dropdown-toggle p-1" data-bs-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
                        <i class="fa-solid fa-ellipsis-vertical"></i>
                    </a>
                    <div class="dropdown-menu dropdown-menu-end">
                        <a class="dropdown-item" href="#">View Detail</a>
                        <a class="dropdown-item" href="#">Clear All</a>
                        <a class="dropdown-item" href="#">Delete</a>
                    </div>
                </div>
                <img src="assets/images/logos/lang-logo/gdrive.png" class="me-2 align-self-center thumb-xl" alt="...">
                <h5 class="fw-semibold mt-3 fs-14">Google Drive</h5>
                <div class="d-flex justify-content-between my-2">
                    <p class="text-muted mb-0 fs-13 fw-semibold"><span class="text-dark">34 </span>Files</p>
                    <p class="text-muted mb-0 fs-13 fw-semibold"><span class="text-dark">500 </span>GB</p>
                </div>
                <div class="d-flex align-items-center">
                    <div class="flex-grow-1 text-truncate">
                        <div class="d-flex align-items-center">
                            <div class="progress bg-secondary-subtle w-100" style="height:5px;" role="progressbar" aria-label="Success example" aria-valuenow="25" aria-valuemin="0" aria-valuemax="100">
                                <div class="progress-bar bg-secondary" style="width: 38%"></div>
                            </div>
                            <small class="flex-shrink-1 ms-1">38%</small>
                        </div>
                    </div><!--end media body-->
                </div><!--end media-->
            </div><!--end card-body-->
        </div><!--end card-->
    </div> <!--end col-->
    <div class="col-md-6 col-lg-3">
        <div class="card">
            <div class="card-body">
                <div class="dropdown float-end">
                    <a href="#" class="text-muted fs-16 dropdown-toggle p-1" data-bs-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
                        <i class="fa-solid fa-ellipsis-vertical"></i>
                    </a>
                    <div class="dropdown-menu dropdown-menu-end">
                        <a class="dropdown-item" href="#">View Detail</a>
                        <a class="dropdown-item" href="#">Clear All</a>
                        <a class="dropdown-item" href="#">Delete</a>
                    </div>
                </div>
                <img src="assets/images/logos/lang-logo/dropbox.png" class="me-2 align-self-center thumb-xl" alt="...">
                <h5 class="fw-semibold mt-3 fs-14">Dropbox</h5>
                <div class="d-flex justify-content-between my-2">
                    <p class="text-muted mb-0 fs-13 fw-semibold"><span class="text-dark">68 </span>Files</p>
                    <p class="text-muted mb-0 fs-13 fw-semibold"><span class="text-dark">500 </span>GB</p>
                </div>
                <div class="d-flex align-items-center">
                    <div class="flex-grow-1 text-truncate">
                        <div class="d-flex align-items-center">
                            <div class="progress bg-secondary-subtle w-100" style="height:5px;" role="progressbar" aria-label="Success example" aria-valuenow="25" aria-valuemin="0" aria-valuemax="100">
                                <div class="progress-bar bg-secondary" style="width: 15%"></div>
                            </div>
                            <small class="flex-shrink-1 ms-1">15%</small>
                        </div>
                    </div><!--end media body-->
                </div><!--end media-->
            </div><!--end card-body-->
        </div><!--end card-->
    </div> <!--end col-->
    <div class="col-md-6 col-lg-3">
        <div class="card">
            <div class="card-body">
                <div class="dropdown float-end">
                    <a href="#" class="text-muted fs-16 dropdown-toggle p-1 " data-bs-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
                        <i class="fa-solid fa-ellipsis-vertical"></i>
                    </a>
                    <div class="dropdown-menu dropdown-menu-end">
                        <a class="dropdown-item" href="#">View Detail</a>
                        <a class="dropdown-item" href="#">Clear All</a>
                        <a class="dropdown-item" href="#">Delete</a>
                    </div>
                </div>
                <img src="assets/images/logos/lang-logo/onedrive.png" class="me-2 align-self-center thumb-xl" alt="...">
                <h5 class="fw-semibold mt-3 fs-14">Onedrive</h5>
                <div class="d-flex justify-content-between my-2">
                    <p class="text-muted mb-0 fs-13 fw-semibold"><span class="text-dark">192 </span>Files</p>
                    <p class="text-muted mb-0 fs-13 fw-semibold"><span class="text-dark">500 </span>GB</p>
                </div>
                <div class="d-flex align-items-center">
                    <div class="flex-grow-1 text-truncate">
                        <div class="d-flex align-items-center">
                            <div class="progress bg-secondary-subtle w-100" style="height:5px;" role="progressbar" aria-label="Success example" aria-valuenow="25" aria-valuemin="0" aria-valuemax="100">
                                <div class="progress-bar bg-secondary" style="width: 48%"></div>
                            </div>
                            <small class="flex-shrink-1 ms-1">48%</small>
                        </div>
                    </div><!--end media body-->
                </div><!--end media-->
            </div><!--end card-body-->
        </div><!--end card-->
    </div> <!--end col-->
    <div class="col-md-6 col-lg-3">
        <div class="card">
            <div class="card-body">
                <div class="dropdown float-end">
                    <a href="#" class="text-muted fs-16 dropdown-toggle p-1" data-bs-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
                        <i class="fa-solid fa-ellipsis-vertical"></i>
                    </a>
                    <div class="dropdown-menu dropdown-menu-end">
                        <a class="dropdown-item" href="#">View Detail</a>
                        <a class="dropdown-item" href="#">Clear All</a>
                        <a class="dropdown-item" href="#">Delete</a>
                    </div>
                </div>
                <img src="assets/images/logos/lang-logo/server.png" class="me-2 align-self-center thumb-xl" alt="...">
                <h5 class="fw-semibold mt-3 fs-14">Server</h5>
                <div class="d-flex justify-content-between my-2">
                    <p class="text-muted mb-0 fs-13 fw-semibold"><span class="text-dark">81 </span>Files</p>
                    <p class="text-muted mb-0 fs-13 fw-semibold"><span class="text-dark">500 </span>GB</p>
                </div>
                <div class="d-flex align-items-center">
                    <div class="flex-grow-1 text-truncate">
                        <div class="d-flex align-items-center">
                            <div class="progress bg-secondary-subtle w-100" style="height:5px;" role="progressbar" aria-label="Success example" aria-valuenow="25" aria-valuemin="0" aria-valuemax="100">
                                <div class="progress-bar bg-secondary" style="width: 76%"></div>
                            </div>
                            <small class="flex-shrink-1 ms-1">76%</small>
                        </div>
                    </div><!--end media body-->
                </div><!--end media-->
            </div><!--end card-body-->
        </div><!--end card-->
    </div> <!--end col-->
</div><!--end row-->
@code {
    protected override async Task OnInitializedAsync()
    {
        PageTitleService.CurrentTitle = "Exportation des données";
    }

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (firstRender)
        {
            await UserConnection.LoadCredentialsAsync();
            StateHasChanged(); // Demande un nouveau rendu du composant
        }
    }


    private async Task ExportClients(string format)
    {
        using var _context = await DbContextFactory.CreateDbContextAsync();

        if (format == "csv")
        {
            var bytes = await ExportService.GenerateCsvAsync(_context.Clients);
            using var stream = new MemoryStream(bytes);
            var streamRef = new DotNetStreamReference(stream);

            await JSRuntime.InvokeVoidAsync("downloadFileFromStream", "clients.csv", streamRef);
        }
        else
        {
            var bytes = await ExportService.GenerateExcelAsync(_context.Clients);
            using var stream = new MemoryStream(bytes);
            var streamRef = new DotNetStreamReference(stream);

            await JSRuntime.InvokeVoidAsync("downloadFileFromStream", "clients.csv", streamRef);
        }
    }

    private async Task ExportVehicles(string format)
    {
        using var _context = await DbContextFactory.CreateDbContextAsync();

        if (format == "csv")
        {
            var bytes = await ExportService.GenerateCsvAsync(_context.Vehicles);
            using var stream = new MemoryStream(bytes);
            var streamRef = new DotNetStreamReference(stream);

            await JSRuntime.InvokeVoidAsync("downloadFileFromStream", "clients.csv", streamRef);
        }
        else
        {
            var bytes = await ExportService.GenerateExcelAsync(_context.Vehicles);
            using var stream = new MemoryStream(bytes);
            var streamRef = new DotNetStreamReference(stream);

            await JSRuntime.InvokeVoidAsync("downloadFileFromStream", "clients.csv", streamRef);
        }
    }


    private async Task ExportInventorys(string format)
    {
        using var _context = await DbContextFactory.CreateDbContextAsync();

        if (format == "csv")
        {
            var bytes = await ExportService.GenerateCsvAsync(_context.Inventorys);
            using var stream = new MemoryStream(bytes);
            var streamRef = new DotNetStreamReference(stream);

            await JSRuntime.InvokeVoidAsync("downloadFileFromStream", "clients.csv", streamRef);
        }
        else
        {
            var bytes = await ExportService.GenerateExcelAsync(_context.Inventorys);
            using var stream = new MemoryStream(bytes);
            var streamRef = new DotNetStreamReference(stream);

            await JSRuntime.InvokeVoidAsync("downloadFileFromStream", "clients.csv", streamRef);
        }
    }

    private async Task ExportInvoices(string format)
    {
        using var _context = await DbContextFactory.CreateDbContextAsync();

        if (format == "csv")
        {
            var bytes = await ExportService.GenerateCsvAsync(_context.Invoices);
            using var stream = new MemoryStream(bytes);
            var streamRef = new DotNetStreamReference(stream);

            await JSRuntime.InvokeVoidAsync("downloadFileFromStream", "clients.csv", streamRef);
        }
        else
        {
            var bytes = await ExportService.GenerateExcelAsync(_context.Invoices);
            using var stream = new MemoryStream(bytes);
            var streamRef = new DotNetStreamReference(stream);

            await JSRuntime.InvokeVoidAsync("downloadFileFromStream", "clients.csv", streamRef);
        }
    }
}
